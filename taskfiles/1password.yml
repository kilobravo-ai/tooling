---

# see https://taskfile.dev/docs/reference/schema#version
version: "3"

# see https://taskfile.dev/docs/reference/schema#vars
vars:
  ONEPASSWORD_ACCOUNT: "workloads.1password.com"
  ONEPASSWORD_SECRETS_FILE: "{{.USER_WORKING_DIR}}/secrets.op.env"
  OP_RUN: |
    op \
      run \
        --account="{{.ONEPASSWORD_ACCOUNT}}" \
        --env-file="{{.ONEPASSWORD_SECRETS_FILE}}" \
        -- \

# see https://taskfile.dev/docs/reference/schema#task
tasks:
  preflight:
    internal: true
    preconditions:
      # check if the 1Password CLI  binary is available
      - sh: command -v op >/dev/null
        msg: "1Password CLI (op) is required"

      # check if the a secrets file is available
      - sh: test -f "{{.ONEPASSWORD_SECRETS_FILE}}"
        msg: "Secrets file not found: `{{.ONEPASSWORD_SECRETS_FILE}}`"

  env:
    desc: "Print 1Password-enriched environment variables"
    internal: false
    cmds:
      - |
        {{.OP_RUN}} \
          env
    silent: true
